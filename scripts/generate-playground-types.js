#!/usr/bin/env node

/**
 * Bundles all .d.ts files from dist/ into a single TypeScript constant
 * for the playground to use. This avoids complex Monaco module resolution.
 */

import { readdir, readFile, writeFile } from 'fs/promises';
import { join, dirname, relative } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, '..');

async function getAllDtsFiles(dir) {
  const files = [];
  
  async function scan(currentDir) {
    const entries = await readdir(currentDir, { withFileTypes: true });
    
    for (const entry of entries) {
      const fullPath = join(currentDir, entry.name);
      
      if (entry.isDirectory()) {
        await scan(fullPath);
      } else if (entry.name.endsWith('.d.ts')) {
        files.push(fullPath);
      }
    }
  }
  
  await scan(dir);
  return files;
}

async function generatePlaygroundTypes() {
  console.log('ğŸ“¦ Generating playground types...');
  
  const distDir = join(projectRoot, 'dist');
  const outputFile = join(projectRoot, 'playground', 'src', 'w2l-types.ts');
  
  // Get all .d.ts files
  const dtsFiles = await getAllDtsFiles(distDir);
  console.log(`   Found ${dtsFiles.length} .d.ts files`);
  
  // Read all files and create a single bundled type definition
  const typeContents = await Promise.all(
    dtsFiles.map(async (file) => {
      const content = await readFile(file, 'utf-8');
      const relativePath = relative(distDir, file);
      
      // Remove sourcemap comments and .js extensions in imports
      return content
        .replace(/\/\/# sourceMappingURL=.*$/m, '')
        .replace(/from ['"]\.\/(.*?)\.js['"]/g, 'from "./$1"')
        .trim();
    })
  );
  
  // Create a single module declaration with all types
  const bundledTypes = `declare module 'w2l' {
${typeContents.join('\n\n')}
}`;
  
  // Generate the TypeScript file
  const output = `/**
 * W2L Type Definitions for Monaco Editor
 * Auto-generated - do not edit manually
 * 
 * This file is generated by scripts/generate-playground-types.js
 * Run 'npm run build' in the root to regenerate.
 */

export const W2L_TYPES = ${JSON.stringify(bundledTypes)};
`;
  
  await writeFile(outputFile, output, 'utf-8');
  console.log(`âœ… Generated: ${relative(projectRoot, outputFile)}`);
}

generatePlaygroundTypes().catch(error => {
  console.error('âŒ Error generating playground types:', error);
  process.exit(1);
});

